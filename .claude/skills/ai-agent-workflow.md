# AI Agent 长时任务工作流 Skill

基于 Anthropic 的 [Effective harnesses for long-running agents](https://www.anthropic.com/engineering/effective-harnesses-for-long-running-agents) 文章设计，并针对本项目进行了优化。

## 核心原则

1. **文档优先**：所有文档使用 `.md` 格式，统一放在 `docs/` 文件夹
2. **问题追踪**：遇到问题记录到 `docs/problem.md`，包含完整思考过程
3. **需求规划**：开发前先做详细的需求规划
4. **Git 管理**：多用 git 方便监督、检查、回滚

---

## 文档结构

所有文档统一放在项目根目录的 `docs/` 文件夹：

```
docs/
├── requirement.md          # 需求规格说明书
├── feature_list.md        # 功能列表（所有功能初始状态为未通过）
├── progress.md            # 开发进度日志
├── problem.md             # 问题记录（遇到问题时创建/更新）
└── api.md                # API 文档（可选）
```

---

## 开发流程

### 第一阶段：需求规划（Initializer Agent）

**适用场景**：项目的第一次会话

**任务**：创建完整的项目规划文档

**输出文件**：

| 文件 | 说明 |
|------|------|
| `docs/requirement.md` | 需求规格说明书，包含项目目标、技术栈、功能模块 |
| `docs/feature_list.md` | 详细的功能列表，所有功能初始状态为未通过 |
| `docs/progress.md` | 初始进度文件 |
| `init.sh` | 启动开发服务器的脚本 |

#### Feature List 格式（Markdown）

```markdown
## 功能列表

### 用户模块

#### F001 - 用户注册
- **描述**: 用户可以通过邮箱/手机号注册账号
- **步骤**:
  1. 访问注册页面
  2. 填写用户名、邮箱、密码
  3. 点击注册按钮
  4. 系统发送验证邮件
  5. 用户点击邮件中的链接完成验证
- **状态**: 未通过
- **优先级**: 高
```

#### Requirement 格式

```markdown
# 项目需求规格说明书

## 1. 项目概述
- 项目名称：预约系统
- 项目目标：提供一个完整的预约管理平台
- 目标用户：普通用户、商户、管理员

## 2. 技术栈
- 后端：Spring Boot 3.x + MySQL + Redis
- 前端：Vue 3 + TypeScript + Vite

## 3. 功能模块

### 3.1 用户模块
- 用户注册
- 用户登录
- 权限管理

### 3.2 商户模块
- 商户注册
- 商户信息管理
- 服务项目管理

...
```

---

### 第二阶段：编码开发（Coding Agent）

**适用场景**：后续所有会话

**会话启动流程**：

```
1. 运行 pwd 确认工作目录
2. 读取 docs/progress.md 了解已完成工作
3. 读取 git log --oneline -20 了解代码变更
4. 读取 docs/feature_list.md 选择最高优先级的未完成功能
5. 启动开发服务器 (init.sh)
6. 运行基础功能测试，确保环境正常
7. 开始实现选中的功能
```

**会话结束流程**：

```
1. 运行端到端测试验证功能
2. 更新 docs/feature_list.md 中该功能的状态为"已通过"
3. 提交 git commit 并写明描述性提交信息
4. 更新 docs/progress.md 记录本次完成的工作
```

---

## 问题记录规范

### 遇到问题时

当遇到问题时，必须记录到 `docs/problem.md`：

```markdown
# 问题记录

## 问题 N：问题标题

### 问题描述
详细描述遇到的问题...

### 发现时间
2024-01-01 10:00

### 发现场景
在做什么操作时发现的...

### 原因分析
1. 第一层原因...
2. 第二层原因...
3. 根本原因...

### 思考过程
1. 我是如何定位问题的...
2. 我尝试了哪些方法...
3. 为什么这些方法不行...

### 解决过程
1. 第一步尝试...
2. 第二步尝试...
3. 最终解决方案...

### 为什么不用别的方案
- 方案 A：...（为什么不用）
- 方案 B：...（为什么不用）
- 最终选择方案 C：因为...

### 解决结果
- [x] 已解决 / [ ] 未解决

### 经验总结
从这个问题中学到了什么...
```

---

## Coding Agent 系统提示词

**每次开发时使用以下提示词**：

```
你是一个正在开发 appointment_system 项目的 Coding Agent。

请按以下步骤进行：

1. **了解项目现状**：
   - 运行 `pwd` 确认工作目录
   - 运行 `git log --oneline -10` 查看最近的代码提交
   - 读取 `docs/progress.md` 了解已完成的工作
   - 读取 `docs/feature_list.md` 查看所有功能列表

2. **检查初始化脚本**：
   - 如果 `init.sh` 存在，运行它启动开发环境
   - 验证基础功能是否正常工作

3. **选择任务**：
   - 从 `docs/feature_list.md` 中选择优先级最高的「未通过」状态的功能
   - 每次只专注做一个功能

4. **实现功能**：
   - 编写清晰、结构良好的代码
   - 遵循项目中现有的代码模式
   - 添加适当的测试

5. **验证功能**：
   - 运行测试确认功能正常
   - 只有在验证通过后才能将功能标记为「已通过」

6. **提交并更新进度**：
   - 使用描述性的提交信息提交代码
   - 更新 `docs/progress.md` 记录完成的工作
   - 更新 `docs/feature_list.md`，只将已完成功能的「状态」改为「已通过」
   - 禁止删除或修改功能描述

重要原则：
- 增量开发：不要一次性实现多个功能
- 保持代码库干净：代码应该可以直接合并到 main 分支
- 完成后立即提交
- 如果发现现有代码有 bug，先修复再开始新功能
- 文档主语言为中文
- 遇到问题时，把问题记录到 `docs/problem.md`，包括原因、思考过程、解决过程、为什么不用别的方案，要详细且令人信服
```

---

## Git 管理规范

### 提交频率

- 每个功能完成后立即提交
- 不要积累大量未提交的代码

### 提交信息格式

```
<类型>: <简短描述>

[可选的详细描述]
```

类型说明：
- `feat`: 新功能
- `fix`: 修复 bug
- `refactor`: 代码重构
- `docs`: 文档更新
- `style`: 格式调整
- `test`: 测试相关
- `chore`: 构建/工具链更新

示例：
```
feat: 完成用户注册功能

- 实现邮箱注册
- 添加密码加密存储
- 集成邮件验证服务
```

### 分支策略

- 主分支：`main`（保持可直接部署状态）
- 开发分支：`develop`（如有需要）
- 功能分支：`feat/功能名`（可选，复杂功能使用）

---

## 实施要点

### Feature List 最佳实践

1. **详细程度**：每个功能描述要包含用户操作步骤
2. **状态控制**：
   - 只有「未通过」和「已通过」两种状态
   - 只能在完成验证后改为「已通过」
   - 禁止删除或编辑功能描述
3. **优先级**：按重要性排序，高优先级在前

### 测试策略

1. **基础测试**：每次会话开始时运行，确保环境未被破坏
2. **端到端测试**：使用浏览器自动化工具（Puppeteer/Playwright）模拟用户操作
3. **验证不通过不能标记「已通过」**

---

## 适用场景

- ✅ 构建完整的 Web 应用
- ✅ 实现复杂的功能模块
- ✅ 需要多天完成的大型任务

- ❌ 简单的单文件修改
- ❌ 快速问答或调试
- ❌ 小型脚本或工具

---

## 快速开始

### 启动新项目

```
请作为 Initializer Agent 帮我创建项目初始环境：

1. 创建 docs/requirement.md 需求规格说明书
2. 创建 docs/feature_list.md 功能列表
3. 创建 docs/progress.md 进度文件
4. 创建 init.sh 启动脚本
5. 提交初始 git commit

项目目标：<描述你的项目>
技术栈：<描述技术栈>
核心功能：<列出核心功能>
```

### 继续开发

```
请作为 Coding Agent 继续开发：
1. 先读取 docs/progress.md 和 docs/feature_list.md 了解进度
2. 从功能列表中选择最高优先级的未完成功能
3. 启动开发环境并验证基础功能
4. 实现该功能并进行端到端测试
5. 更新文档并提交 git
```

### 检查项目状态

```
请检查当前项目状态：
1. 读取 docs/feature_list.md 统计完成/未完成功能数量
2. 读取 docs/progress.md 查看进度记录
3. 运行 git log --oneline 查看提交历史
4. 检查 docs/problem.md 是否有未解决的问题
```
