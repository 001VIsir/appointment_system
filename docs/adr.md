# 架构决策记录 (ADR)

> 记录项目中重要的技术选型决策

---

## ADR-001: 技术栈精简策略

**日期**: 2026-02-21

**背景**:
项目功能开发完成（36个功能），但分析发现存在过度设计：
- RabbitMQ 引入但未使用
- WebSocket 配置存在但无实际使用
- 多项功能使用 Redis 但单体部署可用更简单方案

**决策**: 采用渐进式简化策略

| 场景 | 当前方案 | 精简方案 | 备注 |
|------|----------|----------|------|
| 消息队列 | RabbitMQ (未用) | 移除，改用 @Async | 降低复杂度 |
| 实时通知 | WebSocket (未用) | 评估后决定保留或移除 | 按需 |
| 缓存 | Redis | Caffeine (单机) | 更轻量 |
| Session | Redis | 内存 Session (单机) | 更简单 |
| 限流 | Redis | Bucket4j (单机) | 无需 Redis |
| 统计 | Redis | 数据库聚合查询 | 更可靠 |
| 配置中心 | Nacos (禁用) | 保持禁用 | 单体不需要 |

**状态**: 已决定，待实施

---

## ADR-002: 缓存方案选择

**日期**: 2026-02-21

**背景**: 需要为缓存层选择合适的方案

**选项**:

1. **Redis** (当前使用)
   - 优点: 分布式支持、持久化、丰富功能
   - 缺点: 需要额外服务、增加复杂度、内存占用大
   - 适用: 多实例部署、需要分布式缓存

2. **Caffeine** (推荐)
   - 优点: 进程内、极快、简单、无额外依赖
   - 缺点: 不支持分布式、单实例内存
   - 适用: 单实例部署、低延迟要求

**决策**: 根据部署场景选择

- **单机部署**: 使用 Caffeine
- **多实例部署**: 保留 Redis

**实施**: 在 `REFACTOR-004` 任务中实现

---

## ADR-003: 异步任务处理

**日期**: 2026-02-21

**背景**: 移除 RabbitMQ 后，需要替代方案处理异步任务

**选项**:

1. **Spring @Async**
   - 优点: 简单、集成好、无额外依赖
   - 缺点: 单机、重启丢失
   - 适用: 大部分异步场景

2. **数据库任务表**
   - 优点: 可靠、可重试、持久化
   - 缺点: 需要额外表、查询开销
   - 适用: 关键任务不能丢失

3. **消息队列 (未来)**
   - 优点: 解耦、削峰
   - 缺点: 需要 RabbitMQ/Kafka
   - 适用: 高并发、复杂业务

**决策**:
- 日常异步任务使用 Spring @Async
- 关键任务使用数据库任务表
- 暂不引入消息队列

**实施**: 在 `REFACTOR-007` 任务中实现

---

## ADR-004: 实时通知方案

**日期**: 2026-02-21

**背景**: WebSocket 配置存在但未使用，需要决定是否实现

**选项**:

1. **轮询**
   - 优点: 最简单、兼容性好
   - 缺点: 有延迟、浪费资源
   - 适用: 实时性要求不高

2. **SSE (Server-Sent Events)**
   - 优点: 单向推送、简单、HTTP/2 支持
   - 缺点: 仅单向、需要 HTTP 连接
   - 适用: 服务端推送客户端

3. **WebSocket**
   - 优点: 双向通信、低延迟
   - 缺点: 复杂、需要额外依赖
   - 适用: 需要双向实时通信

4. **移除** (当前推荐)
   - 优点: 降低复杂度
   - 缺点: 无实时通知
   - 适用: 个人项目不需要实时

**决策**: 先评估业务是否真的需要实时通知，如不需要则完全移除

**实施**: 在 `REFACTOR-002` 任务中评估决定
